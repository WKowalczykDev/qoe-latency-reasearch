<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Badanie QoE Video</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 900px;
        }
        video {
            width: 100%;
            max-width: 800px;
            background: #000;
        }
        video::cue {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 20px;
        }
        .hidden { display: none; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
        }
        input[type="range"] { width: 300px; }
        textarea { width: 100%; height: 60px; }
        .progress {
            font-weight: bold;
            font-size: 18px;
            margin: 10px 0;
        }
        .error {
            color: red;
            padding: 10px;
            background: #fee;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<h1>Badanie QoE Video</h1>

<div id="startScreen" class="section">
    <h2>Witamy w badaniu</h2>
    <p>Obejrzyj filmy i oceń je.</p>
    <label>Twój ID: <input id="participantId" required></label><br><br>
    <button onclick="startTest()">Start</button>
    <div id="startError" class="error hidden"></div>
</div>

<div id="videoScreen" class="hidden section">
    <div class="progress" id="progress"></div>
    <video id="videoPlayer" controls crossorigin="anonymous">
        <track kind="subtitles" id="subtitleTrack" label="Polski" srclang="pl" default>
    </video>
    <div style="margin-top: 20px;">
        <button onclick="document.getElementById('videoPlayer').play()">Play</button>
        <button onclick="document.getElementById('videoPlayer').pause()">Pause</button>
        <button onclick="toggleSubtitles()">Napisy ON/OFF</button>
    </div>
    <div id="videoError" class="error hidden"></div>
</div>

<div id="ratingScreen" class="hidden section">
    <h2>Ocena</h2>

    <div style="margin: 20px 0;">
        <label id="question1"></label><br>
        <input type="range" id="comprehension" min="1" max="5" value="3">
        <strong>Ocena: <span id="val1">3</span></strong>
    </div>

    <div style="margin: 20px 0;">
        <label id="question2"></label><br>
        <input type="range" id="comfort" min="1" max="5" value="3">
        <strong>Ocena: <span id="val2">3</span></strong>
    </div>

    <div style="margin: 20px 0;">
        <label>Uwagi (opcjonalnie):</label><br>
        <textarea id="comments"></textarea>
    </div>

    <button onclick="submitRating()">Dalej</button>
    <div id="ratingError" class="error hidden"></div>
</div>

<div id="completionScreen" class="hidden section">
    <h2>Koniec</h2>
    <p>Dziękujemy!</p>
    <a href="/export">Pobierz CSV</a>
</div>

<script>
    let currentVideoData = null;

    document.getElementById('comprehension').oninput = (e) => {
        document.getElementById('val1').textContent = e.target.value;
    };
    document.getElementById('comfort').oninput = (e) => {
        document.getElementById('val2').textContent = e.target.value;
    };

    document.getElementById('videoPlayer').onended = () => {
        document.getElementById('videoScreen').classList.add('hidden');
        document.getElementById('ratingScreen').classList.remove('hidden');
    };

    function toggleSubtitles() {
        const track = document.getElementById('subtitleTrack');
        if (track.track.mode === 'showing') {
            track.track.mode = 'hidden';
        } else {
            track.track.mode = 'showing';
        }
        console.log('Subtitle mode:', track.track.mode);
    }

    function showError(elementId, message) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.classList.remove('hidden');
        console.error(message);
    }

    function hideError(elementId) {
        document.getElementById(elementId).classList.add('hidden');
    }

    async function startTest() {
        hideError('startError');
        const participantId = document.getElementById('participantId').value.trim();
        if (!participantId) {
            showError('startError', 'Podaj ID uczestnika');
            return;
        }

        try {
            const response = await fetch('/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({participant_id: participantId})
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('startScreen').classList.add('hidden');
                loadNextVideo();
            } else {
                showError('startError', 'Błąd: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            showError('startError', 'Błąd połączenia: ' + error.message);
        }
    }

    async function loadNextVideo() {
        hideError('videoError');

        try {
            const response = await fetch('/next_video');

            if (!response.ok) {
                throw new Error('Błąd pobierania danych wideo');
            }

            const data = await response.json();

            if (data.completed) {
                document.getElementById('videoScreen').classList.add('hidden');
                document.getElementById('ratingScreen').classList.add('hidden');
                document.getElementById('completionScreen').classList.remove('hidden');
                return;
            }

            currentVideoData = data;

            document.getElementById('progress').textContent =
                `Film ${data.index} / ${data.total} (Część ${data.part_number}, opóźnienie: ${data.delay_ms}ms)`;

            document.getElementById('question1').textContent = data.questions.comprehension;
            document.getElementById('question2').textContent = data.questions.comfort;

            const videoPlayer = document.getElementById('videoPlayer');
            const subtitleTrack = document.getElementById('subtitleTrack');

            // Remove all event listeners
            const newVideoPlayer = videoPlayer.cloneNode(true);
            videoPlayer.parentNode.replaceChild(newVideoPlayer, videoPlayer);

            const videoPlayerNew = document.getElementById('videoPlayer');
            const subtitleTrackNew = document.getElementById('subtitleTrack');

            // Set video source
            const videoUrl = `/videos/${data.video}`;
            console.log('Loading video:', videoUrl);
            videoPlayerNew.src = videoUrl;

            // Set subtitle source with delay
            const subtitleUrl = `/subtitles/${data.subtitle}?delay=${data.delay_ms}`;
            console.log('Loading subtitles:', subtitleUrl);
            subtitleTrackNew.src = subtitleUrl;

            // Reset ratings
            document.getElementById('comprehension').value = 3;
            document.getElementById('comfort').value = 3;
            document.getElementById('val1').textContent = 3;
            document.getElementById('val2').textContent = 3;
            document.getElementById('comments').value = '';

            document.getElementById('videoScreen').classList.remove('hidden');
            document.getElementById('ratingScreen').classList.add('hidden');

            // Set up event listeners
            videoPlayerNew.addEventListener('loadedmetadata', function() {
                console.log('Video loaded successfully');
                console.log('Video duration:', videoPlayerNew.duration);

                // Force subtitle track to load and show
                const tracks = videoPlayerNew.textTracks;
                if (tracks.length > 0) {
                    tracks[0].mode = 'showing';
                    console.log('Subtitle track mode set to showing');
                    console.log('Number of cues:', tracks[0].cues ? tracks[0].cues.length : 0);
                }
            });

            videoPlayerNew.addEventListener('error', function(e) {
                console.error('Video error:', e, videoPlayerNew.error);
                showError('videoError', 'Błąd ładowania wideo: ' + (videoPlayerNew.error?.message || 'Unknown'));
            });

            videoPlayerNew.onended = () => {
                document.getElementById('videoScreen').classList.add('hidden');
                document.getElementById('ratingScreen').classList.remove('hidden');
            };

            // Load the video
            videoPlayerNew.load();

            // Monitor subtitle track loading
            subtitleTrackNew.addEventListener('load', function() {
                console.log('Subtitle track loaded successfully');
                const track = subtitleTrackNew.track;
                track.mode = 'showing';
                console.log('Cues loaded:', track.cues ? track.cues.length : 0);
                if (track.cues) {
                    for (let i = 0; i < track.cues.length; i++) {
                        console.log(`Cue ${i}: ${track.cues[i].startTime} - ${track.cues[i].endTime}: ${track.cues[i].text}`);
                    }
                }
            });

            subtitleTrackNew.addEventListener('error', function(e) {
                console.error('Subtitle loading error:', e);
            });

            // Try to autoplay after a short delay
            setTimeout(() => {
                videoPlayerNew.play().catch((error) => {
                    console.log('Autoplay prevented:', error);
                });
            }, 100);

        } catch (error) {
            showError('videoError', 'Błąd: ' + error.message);
        }
    }

    async function submitRating() {
        hideError('ratingError');

        const comprehension = parseInt(document.getElementById('comprehension').value);
        const comfort = parseInt(document.getElementById('comfort').value);
        const comments = document.getElementById('comments').value;

        if (!comprehension || !comfort) {
            showError('ratingError', 'Wybierz oceny');
            return;
        }

        const rating = {
            comprehension_rating: comprehension,
            comfort_rating: comfort,
            comments: comments
        };

        console.log('Submitting rating:', rating);

        try {
            const response = await fetch('/submit_rating', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(rating)
            });

            const data = await response.json();

            if (response.ok) {
                console.log('Rating saved successfully');
                loadNextVideo();
            } else {
                showError('ratingError', 'Błąd zapisu: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            showError('ratingError', 'Błąd połączenia: ' + error.message);
        }
    }
</script>

</body>
</html>