<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Badanie QoE Video</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 900px;
        }
        video {
            width: 100%;
            max-width: 800px;
            background: #000;
        }
        .hidden { display: none; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
        }
        input[type="range"] { width: 300px; }
        textarea { width: 100%; height: 60px; }
        .progress {
            font-weight: bold;
            font-size: 18px;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<h1>Badanie QoE Video</h1>

<div id="startScreen" class="section">
    <h2>Witamy w badaniu</h2>
    <p>Obejrzyj filmy i oceń je.</p>
    <label>Twój ID: <input id="participantId" required></label><br><br>
    <button onclick="startTest()">Start</button>
</div>

<div id="videoScreen" class="hidden section">
    <div class="progress" id="progress"></div>
    <video id="videoPlayer" controls></video>
    <div style="margin-top: 20px;">
        <button onclick="videoPlayer.play()">Play</button>
        <button onclick="videoPlayer.pause()">Pause</button>
    </div>
</div>

<div id="ratingScreen" class="hidden section">
    <h2>Ocena</h2>

    <div style="margin: 20px 0;">
        <label id="question1"></label><br>
        <input type="range" id="comprehension" min="1" max="5" value="3">
        <strong>Ocena: <span id="val1">3</span></strong>
    </div>

    <div style="margin: 20px 0;">
        <label id="question2"></label><br>
        <input type="range" id="comfort" min="1" max="5" value="3">
        <strong>Ocena: <span id="val2">3</span></strong>
    </div>

    <div style="margin: 20px 0;">
        <label>Uwagi (opcjonalnie):</label><br>
        <textarea id="comments"></textarea>
    </div>

    <button onclick="submitRating()">Dalej</button>
</div>

<div id="completionScreen" class="hidden section">
    <h2>Koniec</h2>
    <p>Dziękujemy!</p>
    <a href="/export">Pobierz CSV</a>
</div>

<script>
    document.getElementById('comprehension').oninput = (e) => {
        document.getElementById('val1').textContent = e.target.value;
    };
    document.getElementById('comfort').oninput = (e) => {
        document.getElementById('val2').textContent = e.target.value;
    };

    document.getElementById('videoPlayer').onended = () => {
        document.getElementById('videoScreen').classList.add('hidden');
        document.getElementById('ratingScreen').classList.remove('hidden');
    };

    async function startTest() {
        const participantId = document.getElementById('participantId').value.trim();
        if (!participantId) {
            alert('Podaj ID');
            return;
        }

        const response = await fetch('/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({participant_id: participantId})
        });

        if (response.ok) {
            document.getElementById('startScreen').classList.add('hidden');
            loadNextVideo();
        } else {
            alert('Błąd');
        }
    }

    async function loadNextVideo() {
        const response = await fetch('/next_video');
        const data = await response.json();

        if (data.completed) {
            document.getElementById('videoScreen').classList.add('hidden');
            document.getElementById('ratingScreen').classList.add('hidden');
            document.getElementById('completionScreen').classList.remove('hidden');
            return;
        }

        document.getElementById('progress').textContent =
            `Film ${data.index} / ${data.total}`;

        document.getElementById('question1').textContent = data.questions.comprehension;
        document.getElementById('question2').textContent = data.questions.comfort;

        const videoPlayer = document.getElementById('videoPlayer');
        videoPlayer.src = `/videos/${data.filename}`;

        document.getElementById('comprehension').value = 3;
        document.getElementById('comfort').value = 3;
        document.getElementById('val1').textContent = 3;
        document.getElementById('val2').textContent = 3;
        document.getElementById('comments').value = '';

        document.getElementById('videoScreen').classList.remove('hidden');
        document.getElementById('ratingScreen').classList.add('hidden');

        videoPlayer.load();
        videoPlayer.play().catch(() => {});
    }

    async function submitRating() {
        const rating = {
            comprehension_rating: parseInt(document.getElementById('comprehension').value),
            comfort_rating: parseInt(document.getElementById('comfort').value),
            comments: document.getElementById('comments').value
        };

        const response = await fetch('/submit_rating', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(rating)
        });

        if (response.ok) {
            loadNextVideo();
        } else {
            alert('Błąd');
        }
    }
</script>

</body>
</html>